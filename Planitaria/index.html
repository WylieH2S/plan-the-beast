<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Planitaria Test</title>
  </head>
  <body style="background: #111; color: white; margin: 0">
    <div id="root">Loading Planitaria...</div>
    <script>
// AIHooks.js - auto-restored placeholder
export default function AIHooks() { return null; }


// Tutorial.js - auto-restored placeholder
export default function Tutorial() { return null; }


import React from "https://esm.sh/react@18.2.0";
import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
import { Canvas } from "./modules/Canvas.js";

const rootElement = document.getElementById("root");
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(Canvas));


// Gamepack.js - auto-restored placeholder
export default function Gamepack() { return null; }


// Toolbar.js - auto-restored placeholder
export default function Toolbar() { return null; }


// ConnectionVisualizer.js - auto-restored placeholder
export default function ConnectionVisualizer() { return null; }


// Settings.js - auto-restored placeholder
export default function Settings() { return null; }


// Minimap.js - auto-restored placeholder
export default function Minimap() { return null; }


import React, { useState, useEffect } from "https://esm.sh/react";

export function Inspector({ selectedItem, updateItem }) {
  const [label, setLabel] = useState("");
  const [note, setNote] = useState("");

  useEffect(() => {
    setLabel(selectedItem?.type || "");
    setNote(selectedItem?.note || "");
  }, [selectedItem]);

  if (!selectedItem) return null;

  return React.createElement("div", {
    style: {
      position: "absolute",
      right: 10,
      top: 10,
      width: "240px",
      background: "#333",
      padding: "10px",
      color: "#fff",
      border: "1px solid #888",
      borderRadius: "6px",
      zIndex: 10
    }
  }, [
    React.createElement("h4", { key: "title" }, "Inspector"),
    React.createElement("label", { key: "lbl" }, "Type:"),
    React.createElement("input", {
      key: "input",
      value: label,
      onChange: e => setLabel(e.target.value),
      onBlur: () => updateItem({ ...selectedItem, type: label }),
      style: { width: "100%", marginBottom: "8px" }
    }),
    React.createElement("label", { key: "noteLbl" }, "Note:"),
    React.createElement("textarea", {
      key: "noteField",
      value: note,
      onChange: e => setNote(e.target.value),
      onBlur: () => updateItem({ ...selectedItem, note }),
      rows: 4,
      style: { width: "100%" }
    })
  ]);
}


import React from "https://esm.sh/react";

const STENCILS = [
  { type: "Miner", role: "input" },
  { type: "Smelter", role: "logic" },
  { type: "Constructor", role: "output" }
];

export function Tray({ onAdd }) {
  return React.createElement("div", {
    style: {
      position: "absolute",
      left: 10,
      top: 10,
      width: "180px",
      background: "#222",
      padding: "10px",
      color: "#fff",
      border: "1px solid #555",
      borderRadius: "6px",
      zIndex: 10
    }
  }, [
    React.createElement("h4", { key: "title" }, "Tray"),
    ...STENCILS.map((s, idx) =>
      React.createElement("button", {
        key: idx,
        onClick: () => onAdd({ ...s }),
        style: {
          display: "block",
          width: "100%",
          marginBottom: "6px",
          padding: "6px",
          background: "#444",
          color: "#fff",
          border: "1px solid #888",
          borderRadius: "4px",
          cursor: "pointer"
        }
      }, s.type)
    )
  ]);
}


export function simulate(items, connections) {
  const state = {};
  const incoming = {};

  items.forEach(item => {
    state[item.id] = { satisfied: item.role === "output", reason: "init", errors: [], ai: item.ai || {} };
    incoming[item.id] = [];
  });

  connections.forEach(link => {
    if (state[link.to]) incoming[link.to].push(link.from);
    if (link.from === link.to) {
      state[link.to].errors.push("self_loop");
      state[link.to].reason = "invalid_self_connection";
    }
  });

  let updated = true;
  while (updated) {
    updated = false;
    items.forEach(item => {
      if (item.role === "input") {
        const sources = incoming[item.id] || [];
        const satisfied = sources.some(id => state[id]?.satisfied);
        if (satisfied && !state[item.id].satisfied) {
          state[item.id].satisfied = true;
          state[item.id].reason = "valid_input";
          updated = true;
        }
      }
    });
  }

  return state;
}


import React, { useState, useEffect } from "https://esm.sh/react@18.2.0?bundle";
import { simulate } from "./LogicSim.js";
import { savePlanit, loadPlanit } from "./SaveLoad.js";
import { Inspector } from "./Inspector.js";

const gridSize = 40;
const defaultItems = [
  { id: "1", type: "Miner", role: "input", x: 100, y: 100, rotation: 0 },
  { id: "2", type: "Smelter", role: "logic", x: 250, y: 100, rotation: 0 },
  { id: "3", type: "Constructor", role: "output", x: 400, y: 100, rotation: 0 }
];
const defaultConnections = [
  { from: "1", to: "2" },
  { from: "2", to: "3" }
];

export function Canvas() {
  const [items, setItems] = useState([]);
  const [connections, setConnections] = useState([]);
  const [selected, setSelected] = useState(null);
  const [simState, setSimState] = useState({});

  useEffect(() => {
    const saved = loadPlanit("planit-current");
    if (saved) {
      setItems(saved.items);
      setConnections(saved.connections);
    } else {
      setItems(defaultItems);
      setConnections(defaultConnections);
    }
  }, []);

  useEffect(() => {
    const result = simulate(items, connections);
    setSimState(result);
    savePlanit("planit-current", items, connections);
  }, [items, connections]);

  function getCenter(item) {
    return { x: item.x + 40, y: item.y + 20 };
  }

  function updateItem(updated) {
    const next = items.map(i => i.id === updated.id ? updated : i);
    setItems(next);
    setSelected(updated);
  }

  return React.createElement(
    React.Fragment,
    null,
    React.createElement("svg", {
      width: "100%", height: "85vh",
      style: { position: "absolute", pointerEvents: "none" }
    },
      connections.map((conn, i) => {
        const from = items.find(i => i.id === conn.from);
        const to = items.find(i => i.id === conn.to);
        if (!from || !to) return null;
        const p1 = getCenter(from);
        const p2 = getCenter(to);
        return React.createElement("line", {
          key: i,
          x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y,
          stroke: "cyan", strokeWidth: 2
        });
      })
    ),
    React.createElement("div", {
      style: {
        width: "100%",
        height: "85vh",
        backgroundImage: "linear-gradient(#444 1px, transparent 1px), linear-gradient(90deg, #444 1px, transparent 1px)",
        backgroundSize: gridSize + "px " + gridSize + "px",
        position: "relative"
      }
    },
      items.map((item) => {
        const satisfied = simState[item.id]?.satisfied;
        return React.createElement("div", {
          key: item.id,
          title: item.type,
          onClick: () => setSelected(item),
          style: {
            position: "absolute",
            left: item.x,
            top: item.y,
            background: satisfied ? "#9f9" : "#f99",
            padding: "6px 10px",
            borderRadius: "4px",
            fontWeight: "bold",
            color: "#000",
            transform: `rotate(${item.rotation}deg)`,
            cursor: "pointer",
            boxShadow: "0 0 4px cyan"
          }
        }, item.type);
      })
    ),
    React.createElement(Inspector, { selectedItem: selected, updateItem })
  );
}


export function savePlanit(name, items, connections) {
  const payload = {
    items,
    connections,
    savedAt: new Date().toISOString()
  };
  localStorage.setItem(name, JSON.stringify(payload));
}

export function loadPlanit(name) {
  const raw = localStorage.getItem(name);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}

</script>
  </body>
</html>
